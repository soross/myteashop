/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.crm.club.struts.action;

import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.sql.Date;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.beanutils.BeanUtils;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.DispatchAction;

import com.crm.club.po.UnionBinfo;
import com.crm.club.po.UnionSlog;
import com.crm.club.sevice.dao.intf.UnionServiceDao;
import com.crm.club.struts.form.UnionForm;
import com.crm.group.po.ClubActivity;
import com.crm.page.PageUtil;
import com.crm.pub.GlobVar;
import com.crm.pub.po.TData;
import com.crm.pub.po.TUser;

/** 
 * MyEclipse Struts
 * Creation date: 11-04-2009
 * 
 * XDoclet definition:
 * @struts.action path="/admin/union" name="unionForm" input="/form/union.jsp" parameter="task" scope="request" validate="true"
 */
public class UnionAction extends DispatchAction {
	private UnionServiceDao unionServiceDao;

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	/**
	 * 显示联盟商家
	 */
	public ActionForward showUnion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		UnionBinfo union=new UnionBinfo();
		
		int count = unionServiceDao.getCount(union);
		PageUtil pageUtil = new PageUtil(request,count,GlobVar.PAGESIZE_BY_TEN_DATA);
		List ulist=unionServiceDao.getUnionList(union, pageUtil);
		
		List levlist=unionServiceDao.getDate(new Long(5));
		request.setAttribute("pageUtil", pageUtil);
        request.setAttribute("unionlist", ulist);
        request.setAttribute("levlist", levlist);
        
		
		
		return new ActionForward("/admin/club/showunion.jsp");
	}
	/**
	 * 增加联盟商家页面
	 */
	public ActionForward addJsp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		List levlist=unionServiceDao.getDate(new Long(5));
		List typelist=unionServiceDao.getDate(new Long(8));
		List volist=unionServiceDao.getDate(new Long(101));
		List statelist=unionServiceDao.getDate(new Long(9));
		request.setAttribute("levlist", levlist);
		request.setAttribute("typelist", typelist);
		request.setAttribute("volist", volist);
		request.setAttribute("statelist", statelist);
		return new ActionForward("/admin/club/addunion.jsp");
	}
	/**
	 *添加联盟商家
	 */
	public ActionForward addUnion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		UnionForm unionForm = (UnionForm) form;
		TData lev=unionServiceDao.getObject(new Long(unionForm.getVLevel()));
		TData type=unionServiceDao.getObject(new Long(unionForm.getUnionbType()));
		TData vo=unionServiceDao.getObject(new Long(unionForm.getProperty()));
		TData state=unionServiceDao.getObject(new Long(unionForm.getWorkstatus()));
		UnionBinfo union=new UnionBinfo();
		BeanUtils.copyProperties(union, unionForm);
		union.setProperty(vo.getName());
		union.setVLevel(lev.getName());
		union.setWorkstatus(state.getName());
		union.setUnionbType(type.getName());
		UnionSlog slog=new UnionSlog();
		
		slog.setFullName(unionForm.getFullName());
		slog.setUlevel(lev.getName());
		TUser tuser = (TUser) request.getSession().getAttribute("user");
		slog.setWorker(tuser.getUserid());
		slog.setWorktime(new SimpleDateFormat("yyyy-MM-dd").parse(GlobVar.getDate()));
		unionServiceDao.addUnion(union,slog);
		response.getWriter().print("<script> if(confirm('添加成功,是否继续?')){location.href='"
						+ request.getContextPath()
						+ "/admin/union.do?task=addJsp';}else{location.href='"
						+ request.getContextPath()
						+ "/admin/union.do?task=showUnion';}</script>");
		return null;
	}
	/**
	 * 修改联盟商家页面
	 */
	public ActionForward updateJsp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		String id=request.getParameter("id");
		UnionBinfo union=unionServiceDao.getUnion(new Long(id));

		BeanUtils.copyProperties(unionForm, union);
		TData lev=unionServiceDao.getData(union.getVLevel()) ;
		TData state=unionServiceDao.getData(union.getWorkstatus());
		TData type=unionServiceDao.getData(union.getUnionbType());
		TData vo=unionServiceDao.getData(union.getProperty());
		unionForm.setProperty(vo.getId().toString());
		unionForm.setVLevel(lev.getId().toString());
		unionForm.setWorkstatus(state.getId().toString());
		unionForm.setUnionbType(type.getId().toString());
		unionForm.setLevel(lev.getId().toString());
		List levlist=unionServiceDao.getDate(new Long(5));
		List typelist=unionServiceDao.getDate(new Long(8));
		List volist=unionServiceDao.getDate(new Long(101));
		List statelist=unionServiceDao.getDate(new Long(9));
		request.setAttribute("levlist", levlist);
		request.setAttribute("typelist", typelist);
		request.setAttribute("volist", volist);
		request.setAttribute("statelist", statelist);
		return new ActionForward("/admin/club/updateunion.jsp");
	}
	
	/**
	 * 修改联盟商家
	 */
	public ActionForward updateUnion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
	
		TData lev=unionServiceDao.getObject(new Long(unionForm.getVLevel()));
		TData type=unionServiceDao.getObject(new Long(unionForm.getUnionbType()));
		TData vo=unionServiceDao.getObject(new Long(unionForm.getProperty()));
		TData state=unionServiceDao.getObject(new Long(unionForm.getWorkstatus()));
		UnionBinfo union=new UnionBinfo();
		BeanUtils.copyProperties(union, unionForm);
		union.setProperty(vo.getName());
		union.setVLevel(lev.getName());
		union.setWorkstatus(state.getName());
		union.setUnionbType(type.getName());
		union.setIscheck("0");
		
		if(!unionForm.getVLevel().equals(unionForm.getLevel())){
		UnionSlog slog=new UnionSlog();
		slog.setUnionbId(unionForm.getUnionbId());
		slog.setFullName(unionForm.getFullName());
		slog.setUlevel(lev.getName());
		TUser tuser = (TUser) request.getSession().getAttribute("user");
		slog.setWorker(tuser.getUserid());
		slog.setWorktime(new SimpleDateFormat("yyyy-MM-dd").parse(GlobVar.getDate()));
		unionServiceDao.updateUnion(union, slog);
		}
		else{
			
			unionServiceDao.updateUnion(union);
		}
		response.getWriter().print("<script>alert('修改成功！');location.href='"
				+ request.getContextPath()
				+ "/admin/union.do?task=showUnion';</script>");
		return null;
	}
	/**
	 *删除联盟商家
	 * @throws IOException 
	 */
	public ActionForward deleteUnion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws IOException {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		String id=request.getParameter("id");
		UnionBinfo union=new UnionBinfo();
		union.setUnionbId(new Long(id));
		unionServiceDao.deleteUnion(union);
		response.getWriter().print("<script>alert('删除成功！');location.href='"
				+ request.getContextPath()
				+ "/admin/union.do?task=showUnion';</script>");
		return null;
	}
	/**
	 *注销联盟商家
	 * @throws IOException 
	 */
	public ActionForward updateState(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws IOException {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		String id=request.getParameter("id");
		UnionBinfo union=new UnionBinfo();
		union.setUnionbId(new Long(id));
		unionServiceDao.updateState(union);
		response.getWriter().print("<script>alert('注销成功！');location.href='"
				+ request.getContextPath()
				+ "/admin/union.do?task=showUnion';</script>");
		return null;
	}
	/**
	 * 审核联盟商家界面
	 * @throws InvocationTargetException 
	 * @throws IllegalAccessException 
	 * @throws IOException 
	 */
	public ActionForward checkJsp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws IllegalAccessException, InvocationTargetException, IOException {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		String id=request.getParameter("id");
		UnionBinfo union=unionServiceDao.getUnion(new Long(id));
		
		
		
		BeanUtils.copyProperties(unionForm, union);
		TData lev=unionServiceDao.getData(union.getVLevel()) ;
		TData state=unionServiceDao.getData(union.getWorkstatus());
		TData type=unionServiceDao.getData(union.getUnionbType());
		TData vo=unionServiceDao.getData(union.getProperty());
		request.setAttribute("union", union);
		request.setAttribute("lev", lev);
		request.setAttribute("state", state);
		request.setAttribute("type", type);
		request.setAttribute("vo", vo);
		
		return new ActionForward("/admin/club/checkunion.jsp");
		
	}
	/**
	 * 审核联盟商家
	 * @throws IOException 
	 */
	public ActionForward checkUnion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws IOException {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		unionServiceDao.updateCheck(unionForm.getUnionbId(), unionForm.getIscheck());
		response.getWriter().print("<script>alert('审核成功！');location.href='"
				+ request.getContextPath()
				+ "/admin/union.do?task=showUnion';</script>");
		return null;
	}
	/**
	 * 查询联盟商家
	 */
	public ActionForward searchUnion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		UnionBinfo union=new UnionBinfo();
		if(!"".equals(unionForm.getFullName())&&null!=unionForm.getFullName()){
			union.setFullName(unionForm.getFullName());
		}
		if(!"".equals(unionForm.getVLevel())&&null!=unionForm.getVLevel()){
			TData lev=unionServiceDao.getObject(new Long(unionForm.getVLevel()));
			union.setVLevel(lev.getName());
		}
		int count = unionServiceDao.getCount(union);
		PageUtil pageUtil = new PageUtil(request,count,GlobVar.PAGESIZE_BY_TEN_DATA);
		List ulist=unionServiceDao.getUnionList(union, pageUtil);
		
		List levlist=unionServiceDao.getDate(new Long(5));
		request.setAttribute("pageUtil", pageUtil);
        request.setAttribute("unionlist", ulist);
        request.setAttribute("levlist", levlist);
		
		
		return new ActionForward("/admin/club/showunion.jsp");
	}
	/**
	 * 显示分级日志
	 */
	public ActionForward showLog(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws IOException {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		UnionSlog slog=new UnionSlog();
		
		String[] selectg = unionForm.getSel();
		
		
		if (selectg != null) {
			String gid = "";
			String id = "";
			for (int i = 0; i < selectg.length; i++) {
				gid = gid +","+ selectg[i];
			}
			id = gid.substring(1);
			int rcount = unionServiceDao.getLogCount(id);
			PageUtil pageUtil = new PageUtil(request,rcount,GlobVar.PAGESIZE_BY_TEN_DATA);
			List list=unionServiceDao.getLogList(id, pageUtil) ; 
			request.setAttribute("pageUtil", pageUtil);
	        request.setAttribute("loglist", list);
	        return new ActionForward("/admin/club/showslog.jsp");
		}
		else{
		int rcount = unionServiceDao.getLogCount(slog, "0", "0");
		PageUtil pageUtil = new PageUtil(request,rcount,GlobVar.PAGESIZE_BY_TEN_DATA);
		List list=unionServiceDao.getLogList(slog, pageUtil, "0", "0") ; 
		request.setAttribute("pageUtil", pageUtil);
        request.setAttribute("loglist", list);
        return new ActionForward("/admin/club/showlog.jsp");
		}
		
	}
	/**
	 * 查询分级日志
	 */
	public ActionForward searchLog(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws IOException {
		UnionForm unionForm = (UnionForm) form;// TODO Auto-generated method stub
		UnionSlog slog=new UnionSlog();
		String start="0";
		String end="0";
		
		if(!"".equals(unionForm.getFullName())&&null!=unionForm.getFullName()){
			slog.setFullName(unionForm.getFullName());
		}
        if(!"".equals(unionForm.getStarttime())&&null!=unionForm.getStarttime()){
			start=unionForm.getStarttime();
		}
        if(!"".equals(unionForm.getEndtime())&&null!=unionForm.getEndtime()){
        	
			end=unionForm.getEndtime();
		}
		int rcount = unionServiceDao.getLogCount(slog, start, end);
		PageUtil pageUtil = new PageUtil(request,rcount,GlobVar.PAGESIZE_BY_TEN_DATA);
		List loglist=unionServiceDao.getLogList(slog, pageUtil, start, end);
		request.setAttribute("pageUtil", pageUtil);
        request.setAttribute("loglist", loglist);
		return new ActionForward("/admin/club/showlog.jsp");
		
	}
	public UnionServiceDao getUnionServiceDao() {
		return unionServiceDao;
	}

	public void setUnionServiceDao(UnionServiceDao unionServiceDao) {
		this.unionServiceDao = unionServiceDao;
	}
}